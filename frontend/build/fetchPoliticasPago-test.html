<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>fetchPoliticasPago Function Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-header {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
        }
        .code {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="test-header">üß™ fetchPoliticasPago() Function Test Suite</h1>
        
        <div class="info test-result">
            <strong>Purpose:</strong> Test the fetchPoliticasPago() function in different scenarios to ensure it works correctly.
        </div>
        
        <div class="test-controls">
            <button class="button" onclick="runAllTests()" id="runAllBtn">üöÄ Run All Tests</button>
            <button class="button" onclick="runDebugTest()" id="debugBtn">üîß Test DEBUG Mode</button>
            <button class="button" onclick="runProductionTest()" id="prodBtn">üè≠ Test Production Mode</button>
            <button class="button" onclick="clearResults()" id="clearBtn">üóëÔ∏è Clear Results</button>
        </div>
        
        <div id="testResults"></div>
    </div>

    <script type="module">
        // Test configuration
        const originalDebugMode = localStorage.getItem('DEBUG_MODE') || 'true';
        
        // Utility functions
        function logResult(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const resultElement = document.createElement('div');
            resultElement.className = `test-result ${type}`;
            resultElement.innerHTML = message;
            resultsDiv.appendChild(resultElement);
            console.log(`[${type.toUpperCase()}] ${message.replace(/<[^>]*>/g, '')}`);
        }

        function setLoading(buttonId, loading) {
            const button = document.getElementById(buttonId);
            if (loading) {
                button.disabled = true;
                button.innerHTML = '<span class="spinner"></span> Running...';
            } else {
                button.disabled = false;
                button.innerHTML = button.getAttribute('data-original-text') || button.textContent.replace(/Running.../, '');
            }
        }

        // Store original button texts
        document.querySelectorAll('.button').forEach(btn => {
            btn.setAttribute('data-original-text', btn.innerHTML);
        });

        // Mock fetchPoliticasPago function for testing
        async function mockFetchPoliticasPago(debugMode = true) {
            // Simulate the actual function behavior
            const isDebugMode = debugMode;
            
            if (isDebugMode) {
                // Simulate delay
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Return mock testing data (simulating testingPoliticas)
                return [
                    {
                        id: 1,
                        titulo: 'All Inclusive',
                        descripcion: 'Protecci√≥n completa sin franquicia',
                        franquicia: 0,
                        activo: true,
                        incluye: ['Protecci√≥n completa', 'Sin franquicia', 'Cobertura total'],
                        no_incluye: []
                    },
                    {
                        id: 2,
                        titulo: 'Basic Protection',
                        descripcion: 'Protecci√≥n b√°sica con franquicia reducida',
                        franquicia: 600,
                        activo: true,
                        incluye: ['Protecci√≥n b√°sica', 'Franquicia reducida'],
                        no_incluye: ['Protecci√≥n completa']
                    },
                    {
                        id: 3,
                        titulo: 'Economy',
                        descripcion: 'Protecci√≥n m√≠nima con franquicia est√°ndar',
                        franquicia: 1200,
                        activo: true,
                        incluye: ['Protecci√≥n m√≠nima'],
                        no_incluye: ['Protecci√≥n completa', 'Franquicia reducida']
                    }
                ];
            } else {
                // Simulate API call that might fail
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Simulate API failure and fallback to basic policies
                const apiCallSuccess = Math.random() > 0.5; // 50% chance of API success
                
                if (apiCallSuccess) {
                    return [
                        {
                            id: 1,
                            titulo: 'Premium Coverage',
                            descripcion: 'Coverage premium with full protection',
                            franquicia: 0,
                            activo: true,
                            incluye: ['Full coverage'],
                            no_incluye: []
                        }
                    ];
                } else {
                    // Simulate fallback to basic default policies
                    throw new Error('API call failed - simulated network error');
                }
            }
        }

        // Test function for DEBUG mode
        async function testDebugMode() {
            logResult('<strong>üîß Testing DEBUG Mode...</strong>', 'info');
            
            try {
                const startTime = Date.now();
                const politicas = await mockFetchPoliticasPago(true);
                const endTime = Date.now();
                
                logResult(`‚úÖ DEBUG Mode test completed in ${endTime - startTime}ms`, 'success');
                logResult(`üìä Found ${politicas.length} active payment policies:`, 'info');
                
                politicas.forEach((politica, index) => {
                    logResult(`${index + 1}. <strong>${politica.titulo}</strong> - ${politica.descripcion} (Franquicia: ${politica.franquicia}‚Ç¨)`, 'info');
                });
                
                // Validate results
                const validationChecks = [
                    { name: 'Has policies', check: politicas.length > 0 },
                    { name: 'All policies active', check: politicas.every(p => p.activo === true) },
                    { name: 'All have required fields', check: politicas.every(p => p.id && p.titulo && p.descripcion && typeof p.activo === 'boolean') },
                    { name: 'Response time reasonable', check: (endTime - startTime) < 1000 }
                ];
                
                const passedChecks = validationChecks.filter(check => check.check).length;
                
                logResult(`üîç Validation: ${passedChecks}/${validationChecks.length} checks passed`, 
                    passedChecks === validationChecks.length ? 'success' : 'warning');
                
                validationChecks.forEach(check => {
                    logResult(`${check.check ? '‚úÖ' : '‚ùå'} ${check.name}`, check.check ? 'success' : 'error');
                });
                
                return { success: true, data: politicas };
                
            } catch (error) {
                logResult(`‚ùå DEBUG Mode test failed: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        // Test function for Production mode
        async function testProductionMode() {
            logResult('<strong>üè≠ Testing Production Mode...</strong>', 'info');
            
            try {
                const startTime = Date.now();
                
                try {
                    const politicas = await mockFetchPoliticasPago(false);
                    const endTime = Date.now();
                    
                    logResult(`‚úÖ Production Mode test completed in ${endTime - startTime}ms (API Success)`, 'success');
                    logResult(`üìä Found ${politicas.length} payment policies from API`, 'info');
                    
                    politicas.forEach((politica, index) => {
                        logResult(`${index + 1}. <strong>${politica.titulo}</strong> - ${politica.descripcion}`, 'info');
                    });
                    
                    return { success: true, data: politicas, source: 'api' };
                    
                } catch (apiError) {
                    const endTime = Date.now();
                    logResult(`‚ö†Ô∏è API call failed as expected: ${apiError.message}`, 'warning');
                    logResult(`üîÑ Testing fallback to default policies...`, 'info');
                    
                    // Simulate fallback to default policies
                    const defaultPolicies = [
                        {
                            id: 1,
                            titulo: 'All Inclusive',
                            descripcion: 'Protecci√≥n completa sin franquicia',
                            franquicia: 0,
                            activo: true,
                            incluye: [],
                            no_incluye: []
                        },
                        {
                            id: 2,
                            titulo: 'Economy',
                            descripcion: 'Protecci√≥n b√°sica con franquicia',
                            franquicia: 1200,
                            activo: true,
                            incluye: [],
                            no_incluye: []
                        }
                    ];
                    
                    logResult(`‚úÖ Fallback successful - returned ${defaultPolicies.length} default policies`, 'success');
                    logResult(`‚è±Ô∏è Total time including fallback: ${endTime - startTime}ms`, 'info');
                    
                    return { success: true, data: defaultPolicies, source: 'fallback' };
                }
                
            } catch (error) {
                logResult(`‚ùå Production Mode test failed: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        // Data structure validation test
        async function testDataStructure() {
            logResult('<strong>üîç Testing Data Structure Validation...</strong>', 'info');
            
            try {
                const politicas = await mockFetchPoliticasPago(true);
                
                const requiredFields = ['id', 'titulo', 'descripcion', 'activo'];
                const optionalFields = ['franquicia', 'incluye', 'no_incluye', 'precio', 'tipo'];
                
                let allValid = true;
                const validationResults = [];
                
                politicas.forEach((politica, index) => {
                    const missingFields = requiredFields.filter(field => 
                        !politica.hasOwnProperty(field) || politica[field] === null || politica[field] === undefined
                    );
                    
                    const hasAllRequired = missingFields.length === 0;
                    
                    if (!hasAllRequired) {
                        allValid = false;
                    }
                    
                    validationResults.push({
                        index: index + 1,
                        titulo: politica.titulo,
                        hasAllRequired,
                        missingFields,
                        fieldCount: Object.keys(politica).length
                    });
                });
                
                logResult(`üìã Validated ${politicas.length} policies`, 'info');
                logResult(`${allValid ? '‚úÖ' : '‚ùå'} Data structure validation: ${allValid ? 'PASSED' : 'FAILED'}`, 
                    allValid ? 'success' : 'error');
                
                validationResults.forEach(result => {
                    if (result.hasAllRequired) {
                        logResult(`‚úÖ Policy ${result.index} (${result.titulo}): Valid structure (${result.fieldCount} fields)`, 'success');
                    } else {
                        logResult(`‚ùå Policy ${result.index} (${result.titulo}): Missing fields: ${result.missingFields.join(', ')}`, 'error');
                    }
                });
                
                return { success: allValid, data: validationResults };
                
            } catch (error) {
                logResult(`‚ùå Data structure test failed: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        // Performance test
        async function testPerformance() {
            logResult('<strong>‚ö° Testing Performance...</strong>', 'info');
            
            try {
                const iterations = 5;
                const times = [];
                
                for (let i = 0; i < iterations; i++) {
                    const startTime = Date.now();
                    await mockFetchPoliticasPago(true);
                    const endTime = Date.now();
                    times.push(endTime - startTime);
                }
                
                const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
                const minTime = Math.min(...times);
                const maxTime = Math.max(...times);
                
                logResult(`üìä Performance Results (${iterations} iterations):`, 'info');
                logResult(`‚è±Ô∏è Average: ${avgTime.toFixed(2)}ms`, 'info');
                logResult(`üèÉ Fastest: ${minTime}ms`, 'success');
                logResult(`üêå Slowest: ${maxTime}ms`, maxTime > 1000 ? 'warning' : 'info');
                
                const performanceGrade = avgTime < 500 ? 'Excellent' : avgTime < 1000 ? 'Good' : 'Needs improvement';
                logResult(`üéØ Performance Grade: ${performanceGrade}`, avgTime < 1000 ? 'success' : 'warning');
                
                return { success: true, avgTime, minTime, maxTime, grade: performanceGrade };
                
            } catch (error) {
                logResult(`‚ùå Performance test failed: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        // Main test functions (exposed globally)
        window.runDebugTest = async function() {
            setLoading('debugBtn', true);
            await testDebugMode();
            setLoading('debugBtn', false);
        };

        window.runProductionTest = async function() {
            setLoading('prodBtn', true);
            await testProductionMode();
            setLoading('prodBtn', false);
        };

        window.runAllTests = async function() {
            setLoading('runAllBtn', true);
            
            logResult('<h2>üöÄ Starting fetchPoliticasPago() Comprehensive Test Suite</h2>', 'info');
            logResult('='.repeat(60), 'info');
            
            const results = {
                debugMode: await testDebugMode(),
                productionMode: await testProductionMode(),
                dataStructure: await testDataStructure(),
                performance: await testPerformance()
            };
            
            logResult('='.repeat(60), 'info');
            logResult('<h3>üìä Test Suite Summary</h3>', 'info');
            
            const passedTests = Object.values(results).filter(r => r.success).length;
            const totalTests = Object.keys(results).length;
            
            Object.entries(results).forEach(([testName, result]) => {
                const status = result.success ? '‚úÖ PASSED' : '‚ùå FAILED';
                const details = result.error ? ` - ${result.error}` : '';
                logResult(`${status} ${testName}${details}`, result.success ? 'success' : 'error');
            });
            
            logResult('='.repeat(60), 'info');
            
            if (passedTests === totalTests) {
                logResult(`<h3>üéâ ALL TESTS PASSED! (${passedTests}/${totalTests})</h3>`, 'success');
                logResult('‚úÖ fetchPoliticasPago() function is working correctly in all scenarios.', 'success');
            } else {
                logResult(`<h3>‚ö†Ô∏è SOME TESTS FAILED (${passedTests}/${totalTests} passed)</h3>`, 'warning');
                logResult('üîç Please review the implementation for issues.', 'warning');
            }
            
            setLoading('runAllBtn', false);
            
            return results;
        };

        window.clearResults = function() {
            document.getElementById('testResults').innerHTML = '';
            console.clear();
            logResult('üóëÔ∏è Test results cleared', 'info');
        };

        // Auto-run a basic test on page load
        setTimeout(() => {
            logResult('üîß fetchPoliticasPago() Test Suite loaded successfully!', 'success');
            logResult('üí° Click "Run All Tests" to start comprehensive testing', 'info');
        }, 100);
    </script>
</body>
</html>
